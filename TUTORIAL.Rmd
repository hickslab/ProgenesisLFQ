---
title: "Progenesis QIP"
output:
  html_document:
    theme: journal
    highlight: pygments
    df_print: paged
    toc: true
    toc_float:
      collapsed: false
    number_sections: true
  pdf_document:
    toc: true
  word_document:
    toc: true
---


```{r setup, include = FALSE}
require(knitr)
opts_chunk$set(echo = TRUE)

```


# ProteinLFQ


## Packages
**Load required packages into R session.**

```{r, warning = FALSE, message = FALSE}
library(devtools)
library(tidyverse)
library(Biostrings)

```


## Functions

```{r}
url <- "https://raw.githubusercontent.com/hickslab/ProgenesisLFQ/master/"

source_url(paste0(url, "R/ProgenesisLFQ_Global.R"))

```


## Workflow
> Load Protein Measurements spreadsheet exported from Progenesis.

```{r warning = FALSE}
protm <- "data/20180502_WOS52_Cr_UPS_protm.csv" %>%
  paste0(url, .) %>%
  read_csv(., skip = 2, col_types = cols())

```


> Some protein accessions were grouped together by semicolons (;) in the data. These groups represent homologous proteins with shared peptide identifications. The first accession in each group is generally the most confident inference and is used for analysis, other accessions are considered group members.

```{r}
protm <- protm %>%
  separate(Accession,
           into = c("Accession", "Group members"),
           sep = ";",
           extra = "merge",
           fill = "right")

protm

```

> Define column indeces for the normalized abundance values.

* The Protein Measurements export from Progenesis contains the normalized and raw abundances for each raw file in the experiment.

```{r}
protm %>% names()

```

```{r}
samples <- 11:22

samples

```


> Filter to remove proteins from the contaminant database. 

> Filter to remove proteins if not enough peptide evidence.

* Proteins are identified by unique and shared PSMs, so usually the confidence in our protein identification is greatest with increasing unique peptides. It is common in proteomics to remove "one-hit-wonders" by requiring > 1 unique peptide per protein.

> Select the identifier and abundance columns.

```{r}
data <- protm %>%
  filter(Description != "cRAP") %>%
  filter(`Peptide count` >= 2 & `Unique peptides` >= 1) %>%
  select(Accession, samples) %>%
  data.frame()

data

```


> Example plot construction.

```{r}
plot_jitter <- function(df){
  temp.df <- df %>%
    gather(sample, abundance, -1)
  
  temp.df %>%  
    ggplot(., aes(x = sample, y = abundance, color = sample)) +
    geom_jitter(alpha = 0.5) +
    geom_boxplot(color = "black",
                 fill = NA,
                 outlier.shape = NA,
                 size = 1.5) +
    guides(color = FALSE, fill = FALSE) +
    theme_classic(base_size = 32) +
    coord_flip()

}

data %>% plot_jitter()

```


# PeptideLFQ

> Peptide-Level Quantification

* During raw MS file processing, Progenesis subdivided each LC-MS run into peak features, which are MS1 precursor ions with a defined isotopic cluster with characteristic retention time and monoisotopic mass. The same peak feature coordinates are assigned for every LC-MS run and the summed intensity (abundance) from each is recorded.

* MS2 spectra from data-dependent acquisition (DDA) contain the associated MS1 precursor ion mass and retention time, allowing them to be mapped to peak features.

The Peptide Measurements export from Progenesis contains the normalized abundances, raw abundances, and spectral counts for each identified peptide that was mapped to a MS1 peak feature in each raw file.


## Packages
**Load required packages into R session.**

```{r, warning = FALSE, message = FALSE}
library(devtools)
library(tidyverse)
library(Biostrings)

```


## Functions

```{r}
url <- "https://raw.githubusercontent.com/hickslab/ProgenesisLFQ/master/"

source_url(paste0(url, "R/ProgenesisLFQ_Peptide.R"))

```


## Workflow

### Peptides
> Load Peptide Measurements spreadsheet exported from Progenesis.

```{r warning = FALSE}
pepm <- "data/20180502_WOS52_Cr_UPS_pepm.csv" %>%
  paste0(url, .) %>%
  read_csv(., skip = 2, col_types = cols())

```


> Load Protein Measurements spreadsheet exported from Progenesis.

```{r warning = FALSE}
protm <- "data/20180502_WOS52_Cr_UPS_protm.csv" %>%
  paste0(url, .) %>%
  read_csv(., skip = 2, col_types = cols())

```


### Redox
> Load Peptide Measurements spreadsheet exported from Progenesis.

```{r warning = FALSE}
pepm <- "data/20190123_EWM_AZD1_R_rank-lessthan11-include_uniprot_pepm.csv" %>%
  paste0(url, .) %>%
  read_csv(., skip = 2, col_types = cols())

pepm

```


> Load Protein Measurements spreadsheet exported from Progenesis.

```{r warning = FALSE}
protm <- "data/20190123_EWM_AZD1_R_rank-lessthan11-include_uniprot_protm.csv" %>%
  paste0(url, .) %>%
  read_csv(., skip = 2, col_types = cols())

protm

```


> Load protein sequence database.

```{r}
database <- "data/Cr_uniprot_crap_20190130.fasta" %>%
  readAAStringSet(.)

names(database) <- str_split(names(database), " ", simplify = TRUE)[, 1]

```


> Define column indeces for the normalized abundance values.

```{r}
pepm %>% names()

```

```{r}
samples <- 19:34

samples

```


> Filter to keep peptides with Percolator-adjusted Mascot scores > 13 (*p*-value < 0.05).

> Filter to remove peptides from proteins in the contaminant database.

> Join the protein identification statistics onto the Peptide Measurement data.

* Each peptide was assigned to a single protein accession, which will have identification statistics in the Protein Measurements export file.

> Summarize duplicate peak features.

* There are usually instances of the Peptide Measurements with duplicated peak features and differing peptide identifications:

    + Some features were matched with peptides having identical sequence, modifications, and score, but alternate protein accessions. These groups were reduced to satisfy the principle of parsimony and represented by the protein accession with the highest number of unique peptides, else the protein with the largest confidence score assigned by Progenesis.
    
    + Some features were also duplicated with differing peptide identifications and were reduced to a single peptide with the highest Mascot ion score.
    

> Select the identifier and abundance columns.

```{r}
data <- pepm %>%
  filter(Score > 13) %>%
  filter(Description != "cRAP") %>%
  left_join(., protm, by = "Accession") %>%
  #reduce_features() %>%
  reduce_features_tidy() %>%
  filter_redox(reduced = "NEM") %>%
  get_identifier_redox(database = database, reduced = "NEM") %>%
  reduce_identifiers(group = samples) %>%
  select(Identifier, samples) %>%
  data.frame()

data

```


### Variable Modification
```{r}

```


### Phosphorylation

```{r}

```



# StatLFQ

## Packages
> Load required packages into R session.

```{r, warning = FALSE, message = FALSE}
library(imp4p)
library(broom)

```


## Functions

```{r}
url <- "https://raw.githubusercontent.com/hickslab/ProgenesisLFQ/master/"

source_url(paste0(url, "R/StatLFQ.R"))

```


## Workflow

> Define input data.

```{r}
data <- 

```


> Define the column indeces for replicates in each condition.

* Assuming input data has simplified format of an identifier column followed by abundance columns for each raw file in the experiment.

```{r}
a <- 2:5; b <- 6:9; c <- 10:13 # ???

group <- list("25" = a, "50" = b, "100" = c) # ???

group.compare <- list("25-50" = list(a, b),
                      "25-100" = list(a, c),
                      "50-100" = list(b, c))

a
b
c
group
group.compare

```


> Rename the abundance columns in a simplified "Condition-Replicate" format.

```{r}
data <- data %>%
  rename_columns(., group)

data %>% names()

```


> Filter to keep identifiers with >50% of replicates having nonzero abundances in any condition.

> Perform a log~2~-transformation of abundances as a variance-stabilization. The base R function *log2()* returns "-Inf" for zero values. These instances are changed to "NA" following the transformation.

> Impute missing values ("NA") using a conditional strategy with the `imp4p` package. Iterate by condition and check if each idenfifier has reliable quantitation.

* If at least one replicate has a nonzero abundance, impute other replicates with values drawn from a normal distribution centered on the mean of nonzero replicates.

* If all replicates have nonzero abundance, impute with small values drawn from a normal distribution centered on the lower 25^th^ percentile of abundances. 

```{r}
data2 <- data %>%
  clean_min(., group, nonzero = 3) %>%
  transform_data(., group, method = "log2") %>%
  impute_imp4p(., group)

data2 %>% plot_jitter()

```


## Pairwise *t*-test

> Perform a *t*-test on each identifier for defined condition pairs.

* By default, a two-sided, equal-variance *t*-test is run with Benjamini-Hochberg FDR correction.

```{r}
data3 <- data2 %>%
  calculate_ttest(., group.compare, fdr = TRUE)

```


## One-way ANOVA

> Perform a one-way analysis of variance (ANOVA) on each identifier across conditions.

* By default, a one-way ANOVA is run for all unique conditions with Benjamini-Hochberg FDR correction.

```{r}
data4 <- data2 %>%
  calculate_1anova()

```


## Fold change

> Calculate fold change using the mean replicate abundance for each condition.

* Subtracting log~2~-transformed values is equivalent to dividing the non-transformed values and then transforming: $log2(B) - log2(A) = log2(B/A)$

```{r}
data3 <- data3 %>%
  calculate_fc(., group.compare, difference = TRUE)

```


# PlotLFQ

## Packages
> Load required packages into R session.

```{r, warning = FALSE, message = FALSE}


```


## Functions

```{r}
url <- "https://raw.githubusercontent.com/hickslab/ProgenesisLFQ/master/"

source_url(paste0(url, "R/PlotLFQ.R"))

```


## Theme

> Define custom plotting elements to create a theme.

```{r}
theme_custom <- function(base_size = 32){
  theme_bw(base_size = base_size) %+replace%
    theme(
      strip.background = element_blank(),
      strip.text.x = element_text(size = 18),
      strip.text.y = element_text(size = 18),
      axis.text.x = element_text(size=14),
      axis.text.y = element_text(size=14,hjust=1),
      axis.ticks =  element_line(colour = "black"), 
      axis.title.x= element_text(size=16),
      axis.title.y= element_text(size=16,angle=90),
      panel.background = element_blank(), 
      panel.border = element_blank(), 
      panel.grid.major = element_blank(), 
      panel.grid.minor = element_blank(), 
      #panel.margin = unit(1.0, "lines"), 
      plot.background = element_blank(), 
      plot.margin = unit(c(0.5,  0.5, 0.5, 0.5), "lines"),
      axis.line.x = element_line(color="black", size = 1),
      axis.line.y = element_line(color="black", size = 1)
    )
}

theme_custom2 <- function(){
  theme_classic(base_size = 32) %+replace%
    theme(
      strip.background = element_blank()
      
    )
}

```

## PCA

> Principal component analysis (PCA)

```{r}
data2 %>%
  plot_pca(., group)

```


## Volcano Plot

> Biological versus statistical significance

```{r}
data3 %>%
    plot_volcano(.,
                 group,
                 group.compare,
                 fdr = TRUE,
                 threshold = 2,
                 xlimit = 3,
                 ylimit = 9) + theme_custom2()

```


# AnnotateLFQ

## Packages
> Load required packages into R session.

```{r, warning = FALSE, message = FALSE}


```


## Functions

```{r}
url <- "https://raw.githubusercontent.com/hickslab/ProgenesisLFQ/master/"

source_url(paste0(url, "R/AnnotateLFQ.R"))

```


## UniProtKB API

> Given a list of protein accessions, access UniProtKB and pull known information.

```{r}


```




# Output

## Saving Data from R

> The *write_csv()* function from the `readr` package in `tidyverse` is one option to save a dataframe copy in the working directory.

```{r}
#data3 %>% write_csv(., "data3.csv")

```

